const JOB_NOT_EXISTS_ERROR="JOB_NOT_EXISTS_ERROR",INTERNAL_ERROR="INTERNAL_ERROR",CODE_OK="OK",PAGE_SIZE=24,SEARCH_PAGE_SIZE=PAGE_SIZE,MAX_PROMPT_DISPLAY_LENGTH=25;var query_interval_id,query_times,queue_len,state,image_urls,job_id,page_num=1,prompt_str=void 0,negative_prompt=void 0,steps=50,width=void 0,height=void 0,guidance_scale=7.5,random_seed=void 0,sampler="ddim",n_samples=void 0,job_not_exists=!1,job_internal_error=!1,image_details=[],search_words="",is_search=!1,beian=!1,host=window.location.host;function SearchByPrompt(e){Init(),search_words=(e?$("#my_search_words"):$("#search_words")).val(),EmptyDisplay(),Search(search_words,page_num,e),page_num++}function SearchIndex(){SearchByPrompt(!1)}function SearchMy(){SearchByPrompt(!0)}function InitLoadPage(){for(ShowNav(),image_details=[],start_page_num=page_num=1;page_num<start_page_num+1;page_num++)if(0==LoadGeneratedImages(page_num,is_my))break;localStorage.clear()}function InitLoadMyPage(){if(ShowNav(),IsLogin()){for(image_details=[],start_page_num=page_num=1;page_num<start_page_num+1;page_num++)if(0==LoadGeneratedImages(page_num,is_my))break}else $("#loginModal").modal("show")}function LoadMyFavoritesPage(){if(ShowNav(),IsLogin()){for(start_page_num=page_num=1;page_num<start_page_num+1;page_num++)if(0==LoadMyFavoriteImages(page_num))break}else $("#loginModal").modal("show")}function ScrollPageIndex(){var e;page_num<=3&&(e=$(this).scrollTop(),$(document).height()-30<=e+$(this).height())&&(is_search?Search(search_words,page_num,is_my):LoadGeneratedImages(page_num,is_my))&&page_num++}function LimitScrollPage(){var e;IsLogin()?(console.log("login"),ScrollPage()):IsLogin()||!(page_num<=3)||3==page_num?1!=beian&&((beian_element=$("#beian")).empty(),(e=$("<a>浙ICP备2023001289号</a>")).attr("href","http://beian.miit.gov.cn"),e.attr("target","_blank"),beian_element.append(e),beian=!0):ScrollPage()}function IsPageBottom(){var e=$(this).scrollTop(),a=$(document).height(),t=$(this).height();return console.log("scrollTop="+e),console.log("scrollHeight="+a),console.log("clientHeight="+t),a<=t+30}function ScrollPage(){var e=$(this).scrollTop();$(document).height()-20<=e+$(this).height()&&(is_search?Search(search_words,page_num,is_my):LoadGeneratedImages(page_num,is_my))&&page_num++}function IsLogin(){return!!(login_info=CheckLogin()).hasOwnProperty("is_login")&&login_info.is_login}function IsAdmin(){return!!(login_info=CheckLogin()).hasOwnProperty("is_admin")&&login_info.is_admin}function CheckLogin(){var a;return $.get("/checkLogin",function(e){try{e.hasOwnProperty("data")?a=e.data:a.is_login=!1}catch(e){console.log(e),a.is_login=!1}}),a}function Init(){image_urls=[],steps=50,guidance_scale=7.5,n_samples=random_seed=height=width=negative_prompt=prompt_str=queue_len=void(query_times=0),job_internal_error=job_not_exists=!(sampler="ddim"),page_num=1,search_words="",is_search=!(image_details=[])}function GenerateInitilize(){Init(),""==$("#width").val()||0==$("#width").val()?(width=512,$("#width").val(width)):$("#width").val()%8!=0&&(temp=parseInt($("#width").val()/8),$("#width").val(8*temp)),""==$("#height").val()||0==$("#height").val()?(height=512,$("#height").val(height)):$("#height").val()%8!=0&&(temp=parseInt($("#height").val()/8),$("#height").val(8*temp)),""!=$("#steps").val()&&0!=$("#steps").val()||(steps=50,$("#steps").val(steps)),""!=$("#n_samples").val()&&0!=$("#n_samples").val()||(n_samples=6,$("#n_samples").val(n_samples)),""!=$("#guidance_scale").val()&&0!=$("#guidance_scale").val()||(guidance_scale=7.5,$("#guidance_scale").val(guidance_scale)),""!=$("#random_seed").val()&&0!=$("#random_seed").val()||(random_seed=42,$("#random_seed").val(random_seed)),""==$("#sampler").val()&&$("#sampler").val("ddim")}function EmptyDisplay(){$("#queue_div").empty(),$("#row_div").empty()}function SetDivById(e,a){$("#"+e).val(a)}function DisplayJobNotExists(e){var a=$("#queue_div");q_text="<p>Job:<red>"+e+"</red> not exists</p>",a.append($(q_text)),$(".container").append(a)}function DisplayError(){var e=$("<div></div>");e.attr("id","queue_div"),q_text="<p>Internal Error</p>",e.append($(q_text)),$(".container").append(e)}function DisplayInProgress(e){for(var a=$("#queue_div"),t=(a.empty(),""),o=0;o<e;o++)t+=".";a.append($("<p>current request is processing"+t+"</p>")),$(".container").append(a)}function DisplayQueue(e){var a=$("#queue_div");a.empty(),a.append($("<p>current request is order <red>"+e+"</red></p>")),$(".container").append(a)}function DisplayPrompt(e){null!=e&&$("#prompt").val(e)}function DisplayJobid(e){null!=e&&$("#job_id").val(e)}function DisplayQueryInfo(){UpdateElementValue("#job_id",job_id),UpdateElementValue("#prompt",prompt_str),UpdateElementValue("#width",width),UpdateElementValue("#height",height),UpdateElementValue("#steps",steps),"undefined"!=steps&&(document.getElementById("steps_show").innerHTML=steps),"undefined"!=guidance_scale&&(document.getElementById("guidance_scale_show").innerHTML=guidance_scale,$("#guidance_scale").val(guidance_scale)),UpdateElementValue("#random_seed",random_seed),UpdateElementValue("#negative_prompt",negative_prompt),void 0!==sampler&&(document.getElementById("sampler").value=sampler),UpdateElementValue("#n_samples",n_samples)}function UpdateElementValue(e,a){console.log(e),console.log(a),void 0!==a&&$(e).val(a)}function UpdateImages(e,a,t,o){for(var n=$("#row_div"),s=0;s<e.length;s++){var r,l=$("<div></div>"),i=(l.addClass("col-sm-3 col-md-2 col-lg-2 mb-1 item"),l.attr("align","center"),e[s]),d=$("<a></a>");d.attr("data-lightbox","photos"),(image_elem=$("<img>")).addClass("img-fluid img-thumbnail"),image_elem.attr("src",i),image_elem.attr("id","list-img"),d.append(image_elem),l.append(d),null!=a&&((i=Array.isArray(a)?(r=$("<span>"+ShortenString(a[s],MAX_PROMPT_DISPLAY_LENGTH)+"</span>"),l.append(r),$("<span>"+a[s]+"</span>")):(r=$("<span>"+ShortenString(a,MAX_PROMPT_DISPLAY_LENGTH)+"</span>"),l.append(r),$("<span>"+a+"</span>"))).attr("id","l_span"),i.hide(),l.append(i)),null!=t&&((d=$("<span>"+t[s]+"</span>")).attr("id","j_span"),d.hide(),l.append(d)),null!=o&&((i=$("<span>"+o[s]+"</span>")).attr("id","i_span"),i.hide(),l.append(i)),n.append(l)}}function ShowQueryResult(e,a){a&&EmptyDisplay();try{var t=e.code;t==CODE_OK?(queue_len=e.data.queue_len,state=null!=e.data.result.state?e.data.result.state:1,prompt_str=e.data.result.prompt,width=e.data.result.width,height=e.data.result.height,steps=e.data.result.steps,guidance_scale=e.data.result.guidance_scale,random_seed=e.data.result.random_seed,negative_prompt=e.data.result.negative_prompt,sampler=e.data.result.sampler,n_samples=e.data.result.n_samples,job_id=e.data.result.job_id,job_not_exists=!1,image_details=e.data.images,1==a&&(DisplayQueryInfo(),0==state?DisplayQueue(queue_len):1==state?DisplayInProgress(query_times++):2==state?(ShowImages(image_details,!1),clearInterval(query_interval_id)):3==state&&(DisplayError(),clearInterval(query_interval_id)))):t==JOB_NOT_EXISTS_ERROR&&(console.log(JOB_NOT_EXISTS_ERROR+":"+job_id),1==a)&&(DisplayJobNotExists(job_id),clearInterval(query_interval_id))}catch(e){job_internal_error=!0,console.log("job_internal_error"),console.log(e),1==a&&(DisplayError(),clearInterval(query_interval_id))}}function QueryOnce(e,a){e={job_id:parseInt(e)};$.post("/query",e,function(e){try{ShowQueryResult(e,a)}catch(e){console.log(e)}})}function Generate(){var o,e={width:$("#width").val(),height:$("#height").val(),random_seed:$("#random_seed").val(),negative_prompt:$("#negative_prompt").val(),prompt:$("#prompt").val(),guidance_scale:$("#guidance_scale").val(),steps:$("#steps").val(),n_samples:$("#n_samples").val(),sampler:$("#sampler").val()};return $.post("/generate",e,function(a){try{var e=a.request_id,t=a.code;o=a.data.job_id,queue_len=a.data.queue_len,"OK"!=t&&console.warn(e+" failed")}catch(e){console.log(e),console.log(a)}}),o}function StepsChange(){var e=$("#steps").val();document.getElementById("steps_show").innerHTML=e}function GuidanceScaleChange(){var e=$("#guidance_scale").val();document.getElementById("guidance_scale_show").innerHTML=e}function Search(e,a,t){is_search=!0,url="/search?page_size="+SEARCH_PAGE_SIZE+"&page_num="+a+"&search_words="+e,1==t&&(url+="&is_my=true");var o=!0;return $.get(url,function(e){try{e.hasOwnProperty("data")&&0<(image_details=e.data.result).length?ShowImages(image_details):o=!1}catch(e){console.log(e),o=!1}}),o}function LoadGeneratedImages(e,a){url="/listImages?page_size="+PAGE_SIZE+"&page_num="+e+"&is_my="+a;var t=!0;return $.get(url,function(e){try{e.hasOwnProperty("data")&&0<(image_details=e.data.result).length?ShowImages(image_details):t=!1}catch(e){console.log(e),t=!1}}),t}function LoadMyFavoriteImages(e){var a=!0;return post_data={page_num:e,page_size:PAGE_SIZE},$.post("/favoriteImages",post_data,function(e){try{e.hasOwnProperty("data")&&0<(image_details=e.data.result).length?ShowImages(image_details,!1):a=!1}catch(e){console.log(e),a=!1}}),a}function ShowImages(e,a=!0){image_urls=[],prompts=[],job_ids=[],image_ids=[];for(var t=0;t<e.length;t++)a?(image_ids.push(e[t].cover_image_id),image_urls.push(e[t].cover_image_url)):(image_ids.push(e[t].image_id),image_urls.push(e[t].image_url)),prompts.push(e[t].prompt),job_ids.push(e[t].job_id);UpdateImages(image_urls,prompts,job_ids,image_ids)}function ShortenString(e,a){return e.length<=a?e:e.substring(0,a-3)+"..."}function GenerateModelParameterDiv(e,a){var t=$("<div></div>"),o=(t.addClass("row mb-1"),$("<div></div>")),n=(o.addClass("row modal-div-block-title"),$("<div></div>"));return n.addClass("row modal-div-block-text"),o.append(e),n.append(a),t.append(o),t.append(n),t}function CopyTextromModal(e){var a=document.createElement("input"),t=document.activeElement;document.getElementById("modal_copy").appendChild(a),a.value=e,a.focus(),a.select();try{var o=document.execCommand("copy")}catch(e){o=!1}return document.getElementById("modal_copy").removeChild(a),t.focus(),o}function GetInfoFromLocalStorage(){null==(job_id=localStorage.getItem("job_id"))?Init():(width=localStorage.getItem("width"),height=localStorage.getItem("height"),random_seed=localStorage.getItem("random_seed"),negative_prompt=localStorage.getItem("negative_prompt"),prompt_str=localStorage.getItem("prompt"),guidance_scale=localStorage.getItem("guidance_scale"),steps=localStorage.getItem("steps"),n_samples=localStorage.getItem("n_samples"),sampler=localStorage.getItem("sampler"))}function LoginUserNav(e,a){$("#register_div").addClass("d-none"),$("#login_div").addClass("d-none"),$("#dropdown_home_div").removeClass("d-none")}function NotLoginUserNav(){$("#register_div").removeClass("d-none"),$("#login_div").removeClass("d-none"),$("#dropdown_home_div").addClass("d-none")}function ErrorPassword(){$("#user_passwd_error").removeClass("d-none")}function ErrorRegister(){$("#register_error").removeClass("d-none")}function UpdateSpanContent(e,a){document.getElementById(e).innerHTML=a,$("#"+e).removeClass("d-none")}function ShowNav(){$.ajax({type:"get",url:"/checkLogin",dataType:"json",async:!1,crossDomain:!0,success:function(e){e.data.is_login?(user_name=e.data.user_name,user_id=e.data.user_id,LoginUserNav(user_name,user_id),document.getElementById("dropdownMenuButton").innerHTML=user_name+"'s Home"):NotLoginUserNav()},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){console.log("fail"),console.log(e.code),console.log(e)})}protocol="127.0.0.1"!=host?"https":"http",$.ajaxSettings.async=!1,null!=document.getElementById("search_words")&&document.getElementById("search_words").addEventListener("keydown",function(e){"Enter"==e.code&&$("#search_btn").click()}),null!=document.getElementById("my_search_words")&&document.getElementById("my_search_words").addEventListener("keydown",function(e){"Enter"==e.code&&$("#my_search_btn").click()}),null!=document.getElementById("my_fav_search_words")&&document.getElementById("my_fav_search_words").addEventListener("keydown",function(e){"Enter"==e.code&&$("#my_fav_search_btn").click()}),$("#search_btn").click(SearchIndex),$("#see_more").click(function(){$("#login").click()}),$("#my_search_btn").click(SearchMy),$("#query_btn").click(function(){job_id=$("#job_id").val(),localStorage.setItem("job_id",job_id);0!=job_id&&/^[0-9]+$/gi.test(job_id)?(Init(),QueryOnce(job_id,!0)):$("#job_id").val("please input job id")}),$("#generate_btn").click(function(){IsLogin()?""==$("#prompt").val()?(console.warn("please input prompt"),$("#prompt").focus()):(GenerateInitilize(),null!=(job_id=Generate())?(null!=query_interval_id&&clearInterval(query_interval_id),QueryOnce(job_id,!0),query_interval_id=setInterval("QueryOnce("+job_id+", true)",1e3)):DisplayError()):$("#loginModal").modal("show")}),window.document.documentElement.setAttribute("data-theme","dark"),$("body").delegate("#list-img","click",function(){$(".modal-image").empty(),$("#modal-prompt").empty(),$("#modal-parameters").empty();QueryOnce($($(this).parents("div").children("#j_span")).text(),!1);var e=$(this).clone();e.removeClass("img-thumbnail"),e.removeAttr("id"),e.addClass("modal_img");$(".modal-image").append(e);var e=$("<span>"+prompt_str+"</span>"),a=(e.attr("id","l_span_prompt"),$($(this).parents("div").children("#j_span")).clone()),t=(a.removeAttr("style"),a.attr("id","job_id_span"),a.hide(),$($(this).parents("div").children("#i_span")).clone()),o=(t.removeAttr("style"),t.attr("id","image_id_span"),t.hide(),$("#modal-prompt")),e=(o.append(e),o.append(a),o.append(t),$("#modal_copy")),a=(e.empty(),e.append("<span class='bi bi-clipboard2'></span> copy prompt"),parameters_elem=$("#modal-parameters"),GenerateModelParameterDiv("Seed",random_seed)),a=(parameters_elem.append(a),GenerateModelParameterDiv("Guidance scale",guidance_scale)),a=(parameters_elem.append(a),GenerateModelParameterDiv("Dimensions",width+"x"+height)),a=(parameters_elem.append(a),""!=negative_prompt&&(a=GenerateModelParameterDiv("Negative prompt",negative_prompt),parameters_elem.append(a)),GenerateModelParameterDiv("Sampler",sampler)),a=(parameters_elem.append(a),GenerateModelParameterDiv("Steps",steps)),o=(parameters_elem.append(a),$("#job_id_span").text());localStorage.setItem("job_id",o),localStorage.setItem("width",width),localStorage.setItem("height",height),localStorage.setItem("random_seed",random_seed),localStorage.setItem("negative_prompt",negative_prompt),localStorage.setItem("prompt",prompt_str),localStorage.setItem("guidance_scale",guidance_scale),localStorage.setItem("steps",steps),localStorage.setItem("n_samples",n_samples),localStorage.setItem("sampler",sampler),IsLogin()?(t=$("#image_id_span").text(),post_data={image_id:t},IsAdmin()&&($("#modal_ban").removeClass("d-none"),$.ajax({type:"post",url:"/isBan",data:post_data,dataType:"json",async:!0,crossDomain:!0,success:function(e){"success"==e.message&&(1==e.data.is_ban?($("#span_ban").removeClass("bi-eye bi-eye-slash"),$("#span_ban").addClass("bi-eye-slash")):($("#span_ban").removeClass("bi-eye bi-eye-slash"),$("#span_ban").addClass("bi-eye")))},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){$("#span_ban").removeClass("bi-eye bi-eye-slash"),$("#span_ban").addClass("bi-eye"),console.log("fail"),console.log(e.code),console.log(e)})),$.ajax({type:"post",url:"/isFavorite",data:post_data,dataType:"json",async:!0,crossDomain:!0,success:function(e){"success"==e.message&&(1==e.data.is_fav?($("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart-fill")):($("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart")))},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){$("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart"),console.log("fail"),console.log(e.code),console.log(e)})):($("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart")),$("#imageDetailModal").modal("show")}),$("body").delegate("#modal-close","click",function(){$("#imageDetailModal").modal("hide")}),$("body").delegate("#modal-editor","click",function(){window.open("editor.html")}),$("body").delegate("#modal_copy","click",function(){$("#modal_copy").empty(),CopyTextromModal($("#l_span_prompt").text()),$("#modal_copy").append("<span class='bi bi-clipboard2-check'>copied</span>")}),$("body").delegate("#modal_ban","click",function(){var e=$("#image_id_span").text(),a=$("#span_ban").attr("class");IsAdmin()?"bi bi-eye"==a?(post_data={image_id:e,is_ban:!0},$.post("/ban",post_data,function(e){try{"success"==e.message?($("#span_ban").removeClass("bi-eye bi-eye-slash"),$("#span_ban").addClass("bi-eye-slash")):alert(e.message)}catch(e){console.log(e)}})):(post_data={image_id:e,is_ban:!1},$.post("/ban",post_data,function(e){try{"success"==e.message?($("#span_ban").removeClass("bi-eye bi-eye-slash"),$("#span_ban").addClass("bi-eye")):alert(e.message)}catch(e){console.log(e)}})):$("#loginModal").modal("show")}),$("body").delegate("#modal_favorite","click",function(){var e=$("#image_id_span").text(),a=$("#span_fav").attr("class");IsLogin()?"bi bi-heart"==a?(post_data={image_id:e,is_fav:!0},$.post("/favorite",post_data,function(e){try{"success"==e.message?($("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart-fill")):alert(e.message)}catch(e){console.log(e)}})):(post_data={image_id:e,is_fav:!1},$.post("/favorite",post_data,function(e){try{"success"==e.message?($("#span_fav").removeClass("bi-heart bi-heart-fill"),$("#span_fav").addClass("bi-heart")):alert(e.message)}catch(e){console.log(e)}})):$("#loginModal").modal("show")}),$("body").delegate("#login","click",function(){$("#loginModal").modal("show")}),$("body").delegate("#register","click",function(){$("#registerModal").modal("show")}),$("#register_btn").click(function(){var e=$("#register_password").val();$("#register_username").val().length<6?UpdateSpanContent("register_error","username is too short, at least 6 characters"):e.length<6?UpdateSpanContent("register_error","password is too short, , at least 6 characters"):(encrpt_password=md5(e),e={username:$("#register_username").val(),password:encrpt_password},$.ajax({type:"post",url:"/register",data:e,dataType:"json",async:!1,crossDomain:!0,success:function(e){try{e.hasOwnProperty("data")?e.data.is_login?(user_name=e.data.user_name,user_id=e.data.user_id,$("#registerModal").modal("hide"),LoginUserNav(user_name,user_id)):UpdateSpanContent("register_error",e.message):"USER_EXISTS_ERROR"==e.code||"PARAMETER_ERROR"==e.code?UpdateSpanContent("register_error",e.message):UpdateSpanContent("register_error","Internal Error")}catch(e){console.log(e),console.log("ErrorInput in exception"),ErrorRegister()}},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){console.log("fail"),console.log(e.code),console.log(e)}))}),$("#login_btn").click(function(){encrpt_password=md5($("#login_password").val());var e={username:$("#login_username").val(),password:encrpt_password};$.ajax({type:"post",url:"/login",data:e,dataType:"json",async:!1,crossDomain:!0,success:function(e){try{e.data.is_login?(user_name=e.data.user_name,user_id=e.data.user_id,$("#loginModal").modal("hide"),location.reload()):UpdateSpanContent("user_passwd_error","username and password are not correct")}catch(e){console.log(e),console.log("ErrorPassword in exception"),UpdateSpanContent("user_passwd_error","username and password are not correct")}},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){console.log("fail"),console.log(e.code),console.log(e)})}),$("#logout").click(function(){$.ajax({type:"get",url:"/logout",async:!1,crossDomain:!0,success:function(e){try{1!=e.data.is_login?location.reload():console.log("got error when logout")}catch(e){console.log("got error when logout"),location.reload()}},error:function(e,a,t){console.warn(e.status),console.warn(e.readyState),console.warn(a)},complete:function(e,a){200!=e.status&&console.warn("request complete:"+e.status)}}).fail(function(e){console.log("fail"),console.log(e.code),console.log(e)})});